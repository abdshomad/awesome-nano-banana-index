<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Index Viewer</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #eab308;
            /* Yellow-ish for banana */
            --border: #334155;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Header */
        header {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        input[type="text"] {
            background: var(--bg-color);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            width: 300px;
            font-size: 0.9rem;
        }

        button {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover,
        button.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        /* Container */
        .container {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Grid View */
        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            border-color: var(--accent);
        }

        .card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #000;
        }

        .card-body {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }

        .card-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .badge {
            display: inline-block;
            background: rgba(234, 179, 8, 0.1);
            color: var(--accent);
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* List View */
        .list-view {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .list-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .list-item:hover {
            border-color: var(--accent);
        }

        .list-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.25rem;
            background: #000;
        }

        .list-info {
            flex: 1;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 1rem;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
        }

        .modal-close:hover {
            color: var(--text-main);
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .modal-body {
                flex-direction: column;
            }
        }

        .modal-image-container {
            flex: 1;
            min-width: 300px;
        }

        .modal-image {
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .modal-details {
            flex: 1.5;
        }

        h2,
        h3 {
            margin-top: 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .label {
            color: var(--text-muted);
        }

        .prompt-box {
            background: #000;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
            border: 1px solid var(--border);
            max-height: 300px;
            overflow-y: auto;
            color: #d4d4d4;
        }

        .copy-btn {
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
            padding-bottom: 2rem;
        }

        .page-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            display: flex;
            align-items: center;
            padding: 0 1rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">üçå Nano Banana Index</div>
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Search prompts...">
            <select id="langFilter" onchange="applyFilters()"
                style="background:var(--bg-color); color:var(--text-main); border:1px solid var(--border); padding:0.5rem; border-radius:0.5rem;">
                <option value="all">All Languages</option>
            </select>
            <select onchange="setGroupBy(this.value)"
                style="background:var(--bg-color); color:var(--text-main); border:1px solid var(--border); padding:0.5rem; border-radius:0.5rem;">
                <option value="none">No Grouping</option>
                <option value="category">Group by Category</option>
            </select>
            <div>
                <button id="gridBtn" class="active" onclick="setView('grid')">Grid</button>
                <button id="listBtn" onclick="setView('list')">List</button>
            </div>
            <select id="gridSize" onchange="setGridColumns(this.value)"
                style="background:var(--bg-color); color:var(--text-main); border:1px solid var(--border); padding:0.5rem; border-radius:0.5rem;"
                title="Grid Columns">
                <option value="auto">Auto Columns</option>
                <option value="2">2 Columns</option>
                <option value="3">3 Columns</option>
                <option value="4">4 Columns</option>
                <option value="5">5 Columns</option>
                <option value="6">6 Columns</option>
            </select>
            <select id="pageSize" onchange="setItemsPerPage(this.value)"
                style="background:var(--bg-color); color:var(--text-main); border:1px solid var(--border); padding:0.5rem; border-radius:0.5rem;"
                title="Items per page">
                <option value="12">12 per page</option>
                <option value="24" selected>24 per page</option>
                <option value="48">48 per page</option>
                <option value="96">96 per page</option>
                <option value="fit">Auto Fit (Screen)</option>
                <option value="all">Show All</option>
            </select>
        </div>
    </header>

    <div class="container">
        <div id="content" class="grid-view">
            <!-- Content injected here -->
        </div>
        <div id="pagination" class="pagination">
            <!-- Pagination injected here -->
        </div>
    </div>

    <!-- Details Modal -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Title</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-image-container">
                    <img id="modalImage" class="modal-image" src="" alt="Prompt Reference">
                </div>
                <div class="modal-details">
                    <div class="info-grid">
                        <span class="label">Author:</span> <span id="modalAuthor">-</span>
                        <span class="label">Source:</span> <a href="#" id="modalLink" target="_blank"
                            style="color: var(--accent)">View Repo</a>
                        <span class="label">Tags:</span> <span id="modalTags">-</span>
                    </div>
                    <h3>Description</h3>
                    <p id="modalDesc" style="color: var(--text-muted); margin-bottom: 1.5rem;">-</p>

                    <h3>Prompt</h3>
                    <div class="prompt-box" id="modalPrompt"></div>
                    <button class="copy-btn" onclick="copyPrompt()">Copy Prompt</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ... existing styles ... */
        .group-header {
            grid-column: 1 / -1;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            text-transform: capitalize;
        }
    </style>
    <script>
        let dbData = [];
        let currentView = 'grid';
        let currentGroupBy = 'none';
        let currentPage = 1;
        let itemsPerPage = 24;
        let gridColumns = 'auto';

        // Populate Languages
        function populateLanguages(data) {
            const languages = new Set(data.map(item => item.language || 'en'));
            const select = document.getElementById('langFilter');
            // Clear existing except first
            while (select.options.length > 1) {
                select.remove(1);
            }

            Array.from(languages).sort().forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.textContent = lang.toUpperCase();
                select.appendChild(option);
            });
        }

        // Fetch Index on Load
        fetch('database/index.json')
            .then(res => res.json())
            .then(data => {
                dbData = data;
                populateLanguages(dbData);
                render(dbData);
            })
            .catch(err => console.error("Failed to load index:", err));

        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            currentPage = 1;
            applyFilters();
        });

        // Group By Switcher
        function setGroupBy(val) {
            currentGroupBy = val;
            currentPage = 1;
            applyFilters();
        }

        // Grid Columns Switcher
        function setGridColumns(val) {
            gridColumns = val;
            if (itemsPerPage === 'fit') {
                calculateFit();
            } else {
                render(getLastFiltered());
            }
        }

        // Items Per Page Switcher
        function setItemsPerPage(val) {
            if (val === 'fit') {
                itemsPerPage = 'fit';
                calculateFit();
            } else {
                itemsPerPage = val === 'all' ? 'all' : parseInt(val);
                currentPage = 1;
                applyFilters();
            }
        }

        // Auto Fit Logic
        function calculateFit() {
            if (itemsPerPage !== 'fit') return;

            // Approximate calculations
            // Header ~ 80px
            // Pagination ~ 80px
            // Margins ~ 4rem = 64px
            // Available height
            const availableH = window.innerHeight - 80 - 80 - 64;

            // Card height approximates: 200px img + ~120px body + gaps = ~340px
            // This is rough, but "fit" implies no scrolling, so we be conservative.
            const cardH = 350;

            const rows = Math.floor(availableH / cardH);
            // Min 1 row
            const safeRows = Math.max(1, rows);

            // Get columns
            const container = document.getElementById('content');
            // We need to know actual columns. If auto, it's tricky without measuring.
            // Helper: approximate card width + gap
            const cardW = 300;
            const availableW = container.clientWidth || (window.innerWidth - 64);
            let cols = 1;

            if (currentView === 'grid') {
                if (gridColumns !== 'auto') {
                    cols = parseInt(gridColumns);
                } else {
                    cols = Math.floor(availableW / cardW);
                }
            }

            cols = Math.max(1, cols);

            // Set temporary items per page for rendering
            // We store the 'fit' mode in a separate var? No, itemsPerPage can stay 'fit'
            // but we need a numeric value for the slicer.
            // Let's use a separate effectiveItemsPerPage accessor or just pass it to render.

            // Actually, let's just use a global override if mode is fit
            const fitCount = safeRows * cols;

            // Re-render
            currentPage = 1;
            render(getLastFiltered(), fitCount);
        }

        // Resize handler for fit mode
        window.addEventListener('resize', () => {
            if (itemsPerPage === 'fit') {
                // Debounce slightly
                clearTimeout(window.resizeTimer);
                window.resizeTimer = setTimeout(calculateFit, 100);
            }
        });

        function changePage(delta) {
            currentPage += delta;
            render(getLastFiltered());
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        let lastFilteredData = [];
        function getLastFiltered() { return lastFilteredData; }

        // View Switcher
        function setView(view) {
            currentView = view;
            const container = document.getElementById('content');
            const gridBtn = document.getElementById('gridBtn');
            const listBtn = document.getElementById('listBtn');

            if (view === 'grid') {
                container.className = 'grid-view';
                gridBtn.classList.add('active');
                listBtn.classList.remove('active');
            } else {
                container.className = 'list-view';
                gridBtn.classList.remove('active');
                listBtn.classList.add('active');
            }
            applyFilters();
        }

        function applyFilters() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const lang = document.getElementById('langFilter').value;

            const filtered = dbData.filter(item => {
                // Language Filter
                if (lang !== 'all' && (item.language || 'en') !== lang) return false;

                // Search Filter
                return (
                    (item.title && item.title.toLowerCase().includes(query)) ||
                    (item.author && item.author.toLowerCase().includes(query)) ||
                    (item.tags && item.tags.some(t => t.toLowerCase().includes(query)))
                );
            });

            // Reset to page 1 on new filter if query changed (implied by this function call logic usually, but let's be safe)
            // Actually, we should only reset page if query changes, but here we call it on every change.
            // For now, let's keep logic simple: re-filtering resets state? 
            // Better: only reset page if data length changes drastically? No, safest is reset.
            // But we can't easily detect "new search" vs "page change" here without more state.
            // Let's rely on change handlers calling this.

            lastFilteredData = filtered;
            render(filtered);
        }

        // Render Items
        function render(allUrlItems, overrideCount = null) {
            const container = document.getElementById('content');
            const pagContainer = document.getElementById('pagination');
            container.innerHTML = '';
            pagContainer.innerHTML = '';

            // Determine effective items per page
            let effectiveLimit = itemsPerPage;
            if (itemsPerPage === 'fit') {
                effectiveLimit = overrideCount || 12; // Fallback if called without calc
            }

            // Update Grid Columns
            if (currentView === 'grid') {
                if (gridColumns === 'auto') {
                    container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
                } else {
                    container.style.gridTemplateColumns = `repeat(${gridColumns}, 1fr)`;
                }
            } else {
                container.style.gridTemplateColumns = '1fr';
            }

            // Pagination Logic
            let items = allUrlItems;
            let totalPages = 1;

            if (effectiveLimit !== 'all' && currentGroupBy === 'none') {
                totalPages = Math.ceil(allUrlItems.length / effectiveLimit);
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                const start = (currentPage - 1) * effectiveLimit;
                const end = start + effectiveLimit;
                items = allUrlItems.slice(start, end);
            }

            if (allUrlItems.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--text-muted);">No results found.</div>';
                return;
            }

            if (items.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--text-muted);">No results found.</div>';
                return;
            }

            if (currentGroupBy === 'category') {
                // Group info buckets
                const groups = {};
                items.forEach(item => {
                    // path is "category/filename.md"
                    const cat = item.path.split('/')[0] || 'Uncategorized';
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(item);
                });

                // Sort categories
                const sortedKeys = Object.keys(groups).sort();

                sortedKeys.forEach(key => {
                    // Render Header
                    const header = document.createElement('div');
                    header.className = 'group-header';
                    header.textContent = key;
                    container.appendChild(header);

                    // Render Items for this group
                    renderItemsToContainer(groups[key], container);
                });
            } else {
                renderItemsToContainer(items, container);
            }

            // Render Pagination
            if (effectiveLimit !== 'all' && currentGroupBy === 'none' && totalPages > 1) {
                const prev = document.createElement('button');
                prev.className = 'page-btn';
                prev.innerHTML = '‚Üê';
                prev.disabled = currentPage === 1;
                prev.onclick = () => changePage(-1);

                const info = document.createElement('div');
                info.className = 'page-info';
                info.textContent = `Page ${currentPage} of ${totalPages}`;

                const next = document.createElement('button');
                next.className = 'page-btn';
                next.innerHTML = '‚Üí';
                next.disabled = currentPage === totalPages;
                next.onclick = () => changePage(1);

                pagContainer.appendChild(prev);
                pagContainer.appendChild(info);
                pagContainer.appendChild(next);
            }
        }

        function renderItemsToContainer(items, container) {
            const frag = document.createDocumentFragment();

            items.forEach(item => {
                const el = document.createElement('div');

                // Fallback image
                const imgUrl = item.image_url || 'https://placehold.co/600x400/1e293b/FFF?text=No+Image';

                if (currentView === 'grid') {
                    el.className = 'card';
                    el.innerHTML = `
                    <img src="${imgUrl}" class="card-img" loading="lazy">
                    <div class="card-body">
                        <div class="card-title">${item.title || 'Untitled'}</div>
                        <div class="card-meta">by ${item.author || 'Unknown'}</div>
                        <div style="margin-top: auto;">
                            ${(item.tags || []).slice(0, 3).map(t => `<span class="badge">${t}</span>`).join(' ')}
                        </div>
                    </div>
                `;
                } else {
                    el.className = 'list-item';
                    el.innerHTML = `
                    <img src="${imgUrl}" class="list-thumb" loading="lazy">
                    <div class="list-info">
                        <div class="card-title" style="margin:0">${item.title || 'Untitled'}</div>
                        <div class="card-meta" style="margin:0">by ${item.author || 'Unknown'}</div>
                    </div>
                    <div>
                         ${(item.tags || []).slice(0, 3).map(t => `<span class="badge">${t}</span>`).join(' ')}
                    </div>
                `;
                }

                el.onclick = () => openDetails(item);
                frag.appendChild(el);
            });

            container.appendChild(frag);
        }

        // Modal Details logic
        async function openDetails(item) {
            document.getElementById('modalTitle').textContent = item.title;
            document.getElementById('modalAuthor').textContent = item.author;
            document.getElementById('modalTags').textContent = (item.tags || []).join(', ');
            document.getElementById('modalLink').href = item.repo_url;
            document.getElementById('modalImage').src = item.image_url || 'https://placehold.co/600x400/1e293b/FFF?text=No+Image';

            document.getElementById('modalDesc').textContent = "Loading...";
            document.getElementById('modalPrompt').textContent = "Loading...";

            document.getElementById('modal').classList.add('open');

            try {
                const res = await fetch(item.path);
                const text = await res.text();

                const parts = text.split('---');
                let body = text;
                if (parts.length >= 3) {
                    body = parts.slice(2).join('---').trim();
                }

                let description = "";
                let prompt = "";

                const descMatch = body.match(/## Description\s+([\s\S]*?)(?=## Prompt|$)/i);
                if (descMatch) description = descMatch[1].trim();

                const promptMatch = body.match(/## Prompt\s+([\s\S]*?)$/i);
                if (promptMatch) prompt = promptMatch[1].trim();

                document.getElementById('modalDesc').textContent = description || "No description available.";
                document.getElementById('modalPrompt').textContent = prompt || "No prompt available.";

            } catch (e) {
                console.error(e);
                document.getElementById('modalDesc').textContent = "Error loading details.";
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('open');
        }

        function copyPrompt() {
            const text = document.getElementById('modalPrompt').textContent;
            navigator.clipboard.writeText(text);
            const btn = document.querySelector('.copy-btn');
            const orig = btn.textContent;
            btn.textContent = "Copied!";
            setTimeout(() => btn.textContent = orig, 2000);
        }

        // Close modal on outside click
        document.getElementById('modal').onclick = (e) => {
            if (e.target.id === 'modal') closeModal();
        }

        // Keyboard Navigation
        document.addEventListener('keydown', (e) => {
            // Ignore if modal is open (optional, but good UX to not change page behind modal)
            if (document.getElementById('modal').classList.contains('open')) {
                if (e.key === 'Escape') closeModal();
                return;
            }

            // Ignore if typing in search
            if (document.activeElement === document.getElementById('searchInput')) return;

            if (e.key === 'ArrowLeft') {
                const prevBtn = document.querySelector('#pagination button:first-child');
                if (prevBtn && !prevBtn.disabled) changePage(-1);
            } else if (e.key === 'ArrowRight') {
                const nextBtn = document.querySelector('#pagination button:last-child');
                if (nextBtn && !nextBtn.disabled) changePage(1);
            }
        });
    </script>

</body>

</html>